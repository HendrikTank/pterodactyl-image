name: Update Pterodactyl Versions

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      panel-update-available: ${{ steps.check.outputs.panel-update-available }}
      wings-update-available: ${{ steps.check.outputs.wings-update-available }}
      panel-latest-version: ${{ steps.check.outputs.panel-latest-version }}
      wings-latest-version: ${{ steps.check.outputs.wings-latest-version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for updates
        id: check
        run: |
          chmod +x scripts/check-updates.sh
          bash scripts/check-updates.sh

  update-panel:
    needs: check-updates
    if: needs.check-updates.outputs.panel-update-available == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create update branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH_NAME="update-panel-${{ needs.check-updates.outputs.panel-latest-version }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Update Panel version
        run: |
          chmod +x scripts/update-versions.sh
          bash scripts/update-versions.sh panel "${{ needs.check-updates.outputs.panel-latest-version }}"
      
      - name: Test Panel Docker build
        run: |
          if [ -f "panel/Dockerfile" ]; then
            docker build -t pterodactyl-panel-test ./panel || exit 1
          fi
      
      - name: Commit and push changes
        run: |
          git add .
          git commit -m "chore: update Pterodactyl Panel to v${{ needs.check-updates.outputs.panel-latest-version }}"
          git push origin "$BRANCH_NAME"
      
      - name: Get Panel release notes
        id: release-notes
        run: |
          RELEASE_NOTES=$(curl -s https://api.github.com/repos/pterodactyl/panel/releases/tags/v${{ needs.check-updates.outputs.panel-latest-version }} | jq -r '.body // "No release notes available"')
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --title "Update Pterodactyl Panel to v${{ needs.check-updates.outputs.panel-latest-version }}" \
            --body "## ðŸš€ Pterodactyl Panel Update

          This PR updates Pterodactyl Panel from the current version to **v${{ needs.check-updates.outputs.panel-latest-version }}**.

          ### Changes
          - Updated Panel Dockerfile with new version
          - Updated environment files
          - Updated README documentation

          ### Release Notes
          ${{ env.RELEASE_NOTES }}

          ### Testing
          - âœ… Docker build test passed
          - â³ Manual testing required

          ---
          *This PR was automatically generated by the update-pterodactyl workflow*" \
            --label "automated,dependencies,panel" \
            --base main \
            --head "$BRANCH_NAME"

  update-wings:
    needs: check-updates
    if: needs.check-updates.outputs.wings-update-available == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create update branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH_NAME="update-wings-${{ needs.check-updates.outputs.wings-latest-version }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Update Wings version
        run: |
          chmod +x scripts/update-versions.sh
          bash scripts/update-versions.sh wings "${{ needs.check-updates.outputs.wings-latest-version }}"
      
      - name: Test Wings Docker build
        run: |
          if [ -f "wings/Dockerfile" ]; then
            docker build -t pterodactyl-wings-test ./wings || exit 1
          fi
      
      - name: Commit and push changes
        run: |
          git add .
          git commit -m "chore: update Pterodactyl Wings to v${{ needs.check-updates.outputs.wings-latest-version }}"
          git push origin "$BRANCH_NAME"
      
      - name: Get Wings release notes
        id: release-notes
        run: |
          RELEASE_NOTES=$(curl -s https://api.github.com/repos/pterodactyl/wings/releases/tags/v${{ needs.check-updates.outputs.wings-latest-version }} | jq -r '.body // "No release notes available"')
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --title "Update Pterodactyl Wings to v${{ needs.check-updates.outputs.wings-latest-version }}" \
            --body "## ðŸš€ Pterodactyl Wings Update

          This PR updates Pterodactyl Wings from the current version to **v${{ needs.check-updates.outputs.wings-latest-version }}**.

          ### Changes
          - Updated Wings Dockerfile with new version
          - Updated environment files
          - Updated README documentation

          ### Release Notes
          ${{ env.RELEASE_NOTES }}

          ### Testing
          - âœ… Docker build test passed
          - â³ Manual testing required

          ---
          *This PR was automatically generated by the update-pterodactyl workflow*" \
            --label "automated,dependencies,wings" \
            --base main \
            --head "$BRANCH_NAME"

  validate-docker-compose:
    needs: [check-updates]
    if: |
      needs.check-updates.outputs.panel-update-available == 'true' ||
      needs.check-updates.outputs.wings-update-available == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate docker-compose syntax
        run: |
          if [ -f "docker-compose.yml" ]; then
            docker compose config > /dev/null || exit 1
            echo "âœ… docker-compose.yml syntax is valid"
          fi
